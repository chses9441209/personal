<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æŠ½ç±¤éŠæˆ²</title>
  <style>
    :root{--bg:#0b1020;--card:#121a33;--muted:#9fb0ff;--txt:#e8edff;}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#050816,var(--bg));color:var(--txt);}
    .wrap{max-width:860px;margin:0 auto;padding:24px;}
    h1{font-size:22px;margin:0 0 16px;}
    .card{background:rgba(18,26,51,.92);border:1px solid rgba(159,176,255,.22);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);}
    .resultBox{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:14px;border-radius:12px;background:rgba(255,255,255,.04);border:1px dashed rgba(159,176,255,.25)}
    .big{font-size:20px;font-weight:800;letter-spacing:.3px}
    .mini{font-size:12px;color:rgba(232,237,255,.7);line-height:1.6}
    textarea,button{border-radius:10px;border:1px solid rgba(159,176,255,.25);background:#0b1330;color:var(--txt);padding:10px 12px;font-size:14px;}
    textarea{width:100%;min-height:140px;resize:vertical;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";font-size:12px;}
    button{cursor:pointer;background:linear-gradient(180deg,#1b2a63,#15224f);border:1px solid rgba(159,176,255,.35);}
    button:hover{filter:brightness(1.08);}
    .spin{animation:flicker .12s infinite;}
    @keyframes flicker{0%{filter:brightness(1)}50%{filter:brightness(1.25)}100%{filter:brightness(1)}}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    kbd{background:#0b1330;border:1px solid rgba(159,176,255,.25);border-bottom-color:rgba(159,176,255,.5);padding:2px 6px;border-radius:6px;font-size:12px;}
  </style>
</head>

<!-- tabindex è®“ body å¯å–å¾—éµç›¤ç„¦é»ï¼ˆæ›´å®¹æ˜“æ”¶åˆ° Spaceï¼‰ -->
<body tabindex="0">
<div class="wrap">
  <h1>ğŸ´ æŠ½ç±¤éŠæˆ²</h1>

  <div class="card">
    <div class="resultBox">
      <div>
        <div class="mini">æœ¬æ¬¡çµæœ</div>
        <div id="result" class="big">å°šæœªæŠ½ç±¤</div>
        <div id="detail" class="mini">æŒ‰ <kbd>Space</kbd> é€²è¡ŒæŠ½ç±¤</div>
      </div>
    </div>

    <div class="row">
      <button id="apply">å¥—ç”¨åå–®</button>
      <span class="mini">åå–®ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰ã€‚æŠ½ç±¤ç”¨ç©ºç™½éµï¼ˆæœƒå…ˆæ´—ç‰Œå†åœä¸‹ï¼‰ã€‚</span>
    </div>

    <div style="margin-top:10px">
      <textarea id="names">OB
æå¤šæŸ”
æ½˜ç¿°æ³“
å°éµ
å°è˜­å§</textarea>
    </div>
  </div>
</div>

<script>
(() => {
  // =========================
  // éš±è—è¨­å®šï¼ˆåªåœ¨ç¨‹å¼ç¢¼å…§ï¼‰
  // =========================
  const LONG_PRESS_THRESHOLD_MS = 600; // é•·æŒ‰é–€æª»ï¼ˆæ¯«ç§’ï¼‰
  const FIXED_FORCE_NAME = "å°è˜­å§";   // é•·æŒ‰å¿…å®šä¸­çš„åå­—ï¼šæ”¹é€™è¡Œå°±å¥½

  const SPIN_TOTAL_MS = 900;           // å‡å‹•ç•«ç¸½æ™‚é–“
  const SPIN_STEP_MS = 60;             // æ¯æ¬¡è·³åé€Ÿåº¦

  // ====== ç‹€æ…‹ ======
  let list = [];
  let isSpaceDown = false;
  let pressStart = 0;
  let spinning = false;
  let spinTimer = null;
  let rafTimer = null;

  const $ = (id) => document.getElementById(id);
  const resultEl = $("result");
  const detailEl = $("detail");
  const namesEl  = $("names");
  const applyBtn = $("apply");

  function parseList() {
    return namesEl.value
      .split(/\r?\n/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function applyList() {
    list = parseList();
    if (list.length === 0) list = ["ï¼ˆåå–®æ˜¯ç©ºçš„ï¼‰"];
    resultEl.textContent = "åå–®å·²å¥—ç”¨ï¼ŒæŒ‰ Space æŠ½ç±¤";
    detailEl.textContent = `ç›®å‰åå–®äººæ•¸ï¼š${list.length}ã€‚æŒ‰ Space æŠ½ç±¤ï¼ˆæœƒå…ˆæ´—ç‰Œï¼‰ã€‚`;
  }

  function getNormalPick() {
    return list[Math.floor(Math.random() * list.length)];
  }

  function getForcedPick() {
    // å¦‚æœå›ºå®šåå­—ä¸åœ¨åå–®ä¸­ï¼Œå°±é€€å›ç¬¬ä¸€å€‹ï¼Œé¿å…é¡¯ç¤º undefined
    if (list.includes(FIXED_FORCE_NAME)) return FIXED_FORCE_NAME;
    return list[0];
  }

  function setControlsEnabled(enabled) {
    applyBtn.disabled = !enabled;
    namesEl.disabled = !enabled;
  }

  // å‡å‹•ç•«ï¼šå…ˆäº‚è·³ï¼Œå†åœåœ¨ finalPick
  function fakeSpinTo(finalPick) {
    if (spinning) return;
    spinning = true;

    resultEl.classList.add("spin");
    detailEl.textContent = "æ´—ç‰Œä¸­â€¦";
    setControlsEnabled(false);

    const start = performance.now();
    spinTimer = setInterval(() => {
      const elapsed = performance.now() - start;

      // äº‚è·³ï¼ˆè¦–è¦ºå…¬å¹³ï¼‰
      resultEl.textContent = list[Math.floor(Math.random() * list.length)];

      if (elapsed >= SPIN_TOTAL_MS) {
        clearInterval(spinTimer);
        spinTimer = null;

        resultEl.textContent = finalPick;
        resultEl.classList.remove("spin");
        detailEl.textContent = "å®Œæˆ âœ…";

        spinning = false;
        setControlsEnabled(true);
      }
    }, SPIN_STEP_MS);
  }

  // çŸ­æŒ‰/é•·æŒ‰åµæ¸¬
  function startHold() {
    pressStart = performance.now();

    const tick = () => {
      // ä½ æƒ³æ›´éš±å¯†å°±æŠŠé€™è¡Œæ”¹æˆå›ºå®šå­—å³å¯
      detailEl.textContent = "æº–å‚™ä¸­â€¦";
      rafTimer = requestAnimationFrame(tick);
    };
    rafTimer = requestAnimationFrame(tick);
  }

  function endHold() {
    if (rafTimer) cancelAnimationFrame(rafTimer);
    rafTimer = null;

    const heldMs = performance.now() - pressStart;

    // çœŸæ­£çµæœï¼ˆUI ä¸é€éœ²è¦å‰‡ï¼‰
    const finalPick = (heldMs >= LONG_PRESS_THRESHOLD_MS)
      ? getForcedPick()
      : getNormalPick();

    fakeSpinTo(finalPick);
  }

  // âœ… å–®ä¸€ç‰ˆæœ¬ï¼šç”¨ capture æ””ç©ºç™½éµï¼Œé¿å…è¢« textarea / é è¨­æ²å‹•åƒæ‰
  document.addEventListener("keydown", (e) => {
    const isSpace = (e.code === "Space" || e.key === " ");
    if (!isSpace) return;

    // é¿å…ç©ºç™½éµæ²å‹• + å„ªå…ˆæ””æˆª
    e.preventDefault();
    e.stopPropagation();

    if (spinning) return;
    if (e.repeat) return;
    if (isSpaceDown) return;

    // è‹¥ç„¦é»åœ¨è¼¸å…¥æ¡†ï¼Œå…ˆ blurï¼ˆä¸ç„¶ç©ºç™½éµæœƒè¢«ç•¶æˆè¼¸å…¥ï¼‰
    const tag = (e.target?.tagName || "").toLowerCase();
    if (tag === "textarea" || tag === "input") e.target.blur();

    isSpaceDown = true;
    startHold();
  }, { capture: true, passive: false });

  document.addEventListener("keyup", (e) => {
    const isSpace = (e.code === "Space" || e.key === " ");
    if (!isSpace) return;

    e.preventDefault();
    e.stopPropagation();

    if (!isSpaceDown) return;
    isSpaceDown = false;

    if (spinning) return;
    endHold();
  }, { capture: true, passive: false });

  // å¤±ç„¦ä¿éšªï¼šæŒ‰ä½ç©ºç™½éµæ™‚åˆ‡èµ°è¦–çª—ï¼Œé¿å…å¡ä½
  window.addEventListener("blur", () => {
    if (!isSpaceDown) return;
    isSpaceDown = false;
    if (rafTimer) cancelAnimationFrame(rafTimer);
    rafTimer = null;
    detailEl.textContent = "ï¼ˆè¦–çª—å¤±ç„¦ï¼Œå·²å–æ¶ˆæœ¬æ¬¡æ“ä½œï¼‰";
  });

  // è®“é é¢æ›´å®¹æ˜“æ‹¿åˆ°éµç›¤ç„¦é»
  function focusBody() { document.body.focus({ preventScroll: true }); }
  window.addEventListener("load", focusBody);
  window.addEventListener("pointerdown", focusBody);

  // åå–®æŒ‰éˆ•
  applyBtn.addEventListener("click", applyList);

  // åˆå§‹åŒ–
  applyList();
})();
</script>
</body>
</html>
